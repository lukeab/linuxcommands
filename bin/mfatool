#!/bin/bash

txtrst='\e[0m'    # Text Reset
txtylw='\e[0;33m' # Yellow
bldgrn='\e[1;32m' # Bold Green
bldred='\e[1;31m' # Bold Red


scriptname="$(basename "$0")"

usage="

LAB mfatool
Tool for managing multifactor authentication tokens through with the security of secret-tool and the keychain

Usage: $scriptname [--help] <user/email> <service/domain>

Options:
 --help|-h        show this help/usage
 --list           List all keys in the secret-tool keychain managed by lab mfatool
 --store          store a value into the keychain (uses secret-tool to write to the keychain), you will be prompted for a password by the secret-tool
 --all            Display all keys managed by mfatool at once in a line by line output

Arguments:
 <user/email>     *required: the username or email address that identifies the key you want to use for the mfatool
 <service/domain> *required: the identifying service name or domain that the key is for

Examples:
 $scriptname --help
 $scriptname luke github.com
 $scriptname --store luke github.com
 $scriptname --all
 
"

nullmfakey=$(oathtool --base32 --totp "")

function get_mfatoken {

	mfakey=$(oathtool --base32 --totp "$(secret-tool lookup labmfatool 2016_01_10 username "${1}" service "${2}")")

	if [[ $nullmfakey == "$mfakey" ]]; then
	  echo -e "${bldred}Not Found:${txtrst} no MFA key found in keychain for ${txtylw}${1}${txtrst}@${txtylw}${2}${txtrst}"; 
	  exit 3;

	else
	  echo -e "MFA token for ${txtylw}${1}${txtrst} @ ${txtylw}${2}${txtrst} :\t${bldgrn}${mfakey}${txtrst}"
	fi
}

if [[ "$1" == "--help"||"$1" == "-h" ]]; then
  echo "$usage";
  exit 0;
fi

if [[ "$1" == "--list" ]]; then
	secret-tool search --all labmfatool 2016_01_10 2>/dev/null |grep "label = "|sed 's/\(.*\)@/\1 /' |awk '{print $3 " " $4}'

	exit 0;
fi

if [[ "$1" == "--all" ]]; then
  ACCOUNTLIST=$(secret-tool search --all labmfatool 2016_01_10 2>/dev/null |grep "label = "|sed 's/\(.*\)@/\1 /' |awk '{print $3 " " $4}')

  while read -r line; do
    get_mfatoken $line
	done <<< "$ACCOUNTLIST"
  
  exit 0;
fi

emailaddr=$1
service=$2

if [[ "$1" == "--store" ]]; then
	emailaddr=$2
  service=$3
fi

if [[ "$emailaddr" == "" ]]; then
  echo -e "${bldred}Error:${txtrst} No user/email provided to identify the key."
  echo "$usage";
  exit 1;
fi

if [[ "$service" == "" ]]; then
  echo "${bldred}Error:${txtrst} No service/domain name provided to identify the key."
  echo "$usage";
  exit 2;
fi

if [[ "$1" == "--store" ]]; then
  secret-tool store --label "${emailaddr}@${service}" labmfatool 2016_01_10 username "${emailaddr}" service "${service}"
else
	get_mfatoken ${emailaddr} "${service}"
fi